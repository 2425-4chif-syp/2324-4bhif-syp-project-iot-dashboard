<div class="d-flex">
  <!-- Sidebar -->
  <div class="sidebar" style="height: 100vh; overflow-y: scroll; -ms-overflow-style: none; scrollbar-width: none; position: fixed; top: 0; left: 0; width: 290px; background-color: #f8f9fa;">
    <!-- Sidebar-Header mit Logo -->
    <div class="sidebar-header">
      <img src="assets/images/new_htl_logo_name.png" alt="Logo" class="logo" style="width: 280px; height: auto;" />
    </div>

    <!-- Gesamter Container für die Modus-Auswahl -->
    <div class="mode-selection-container p-4 mt-5 mb-2 rounded">
      <!-- Überschrift für den Container -->
      <h3 class="mode-selection-title mb-4">Modus</h3>
      <div class="d-flex justify-content-center">
        <!-- PV-Modus -->
        <div class="mode-option d-flex flex-column align-items-center me-5">
          <i class="fas fa-solar-panel mode-icon" title="PV-Daten"></i>
          <input
            type="radio"
            name="mode"
            [(ngModel)]="showPvData"
            [value]="true"
            (change)="toggleDataMode()"
            class="mode-radio mt-3"
          />
        </div>
        <!-- Sensorbox-Modus -->
        <div class="mode-option d-flex flex-column align-items-center">
          <i class="fas fa-broadcast-tower mode-icon" title="Sensorbox"></i>
          <input
            type="radio"
            name="mode"
            [(ngModel)]="showPvData"
            [value]="false"
            (change)="toggleDataMode()"
            class="mode-radio mt-3"
          />
        </div>
      </div>
    </div>

    <!-- Dynamische Sidebar-Elemente -->
    <ul class="sidebar-nav">
      <!-- PV-Daten: Zeige Dashboard, Graphen und Wetter -->
      <ng-container *ngIf="showPvData">
        <li class="sidebar-item">
          <a
            class="sidebar-link"
            href="#"
            (click)="selectAllGraphs(); $event.preventDefault()"
            [class.active]="currentIndex === -1"
          >
            <i class="fas fa-th-large"></i> Dashboard
          </a>
        </li>
        <li class="sidebar-item" *ngFor="let graph of graphs; let i = index">
          <a
            class="sidebar-link"
            href="#"
            (click)="selectGraph(i); $event.preventDefault()"
            [class.active]="currentIndex === i"
          >
            <i class="fas fa-chart-bar"></i> {{ graph.title }}
          </a>
        </li>
        <li class="sidebar-item">
          <a
            class="sidebar-link"
            href="#"
            (click)="selectWeather(); $event.preventDefault()"
            [class.active]="currentIndex === -2"
          >
            <i class="fas fa-cloud-sun"></i> Wetter
          </a>
        </li>
      </ng-container>

      <!-- Sensorbox-Modus: Zeige nur Sensorbox -->
      <ng-container *ngIf="!showPvData">
        <li class="sidebar-item">
          <a
            class="sidebar-link"
            href="#"
            (click)="selectSensorBox(); $event.preventDefault()"
            [class.active]="currentIndex === -3"
          >
            <i class="fas fa-broadcast-tower mode-icon"></i> Sensor-Boxen
          </a>
        </li>
      </ng-container>
    </ul>
  </div>

  <!-- Hauptinhalt -->
  <div class="content" style="margin-left: 290px;">
    <!-- Dashboard-Einstellungen Panel (floating card) -->
    <div *ngIf="showDashboardSettings" class="dashboard-settings-card" style="position: absolute; top: 24px; right: 32px; z-index: 10; min-width: 270px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); border-radius: 16px; background: #fff;">
      <div style="background: linear-gradient(90deg, #ff8c5a 0%, #ffb47a 100%); border-radius: 16px 16px 0 0; padding: 12px 20px; color: #fff; font-weight: 600; font-size: 1.1rem;">Dashboard-Einstellungen</div>
      <div style="padding: 18px 20px 12px 20px;">
        <div style="font-size: 0.98rem; margin-bottom: 8px; color: #444;">
          <span style="font-weight: 600;">Ausgewählt:</span>
          <span>{{ selectedDayObj.day }}. {{ months[selectedDayObj.month] }} {{ selectedYear }}</span>
        </div>
        <div class="form-check form-switch mb-3">
          <label class="form-check-label" for="kioskModeSwitch" style="font-weight: 500;">Kiosk-Mode</label>
          <input class="form-check-input" type="checkbox" id="kioskModeSwitch" [(ngModel)]="kioskMode" (change)="kioskModeChecker()">
        </div>
        <div class="mb-3">
          <label for="intervalSlider" style="font-weight: 500;">Intervall: {{ interval }} Sekunden</label>
          <input type="range" class="form-range" id="intervalSlider" min="5" max="60" step="1" [(ngModel)]="interval" (change)="kioskModeChecker()">
        </div>
        <div>
          <label for="zeitraumSelect" style="font-weight: 500;">Zeitraum</label>
          <select id="zeitraumSelect" class="form-select mt-1" [(ngModel)]="selectedDuration" (change)="changeDuration()">
            <option *ngFor="let duration of durations" [ngValue]="duration">{{ duration.long }}</option>
          </select>
        </div>
      </div>
    </div>
    <!-- Nur eine Header-Section für die Titel und das Zahnrad -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="d-flex flex-column align-items-start">
        <div class="header-center">
          <h1 *ngIf="currentGraph?.title" class="content-title">{{ currentGraph?.title }}</h1>
          <h1 *ngIf="currentIndex === -2" class="content-title">Wetter</h1>
          <h1 *ngIf="currentIndex === -3" class="content-title">
            <img src="assets/images/live-icon.png" alt="Live-Icon" class="live-icon me-2">
            Sensorboxen
          </h1>
        </div>
      </div>
      <!-- Zahnrad-Icon zum Öffnen der Dashboard-Einstellungen -->
      <div class="settings-section ms-auto">
        <button (click)="toggleDashboardSettings()" class="btn btn-link p-0" style="font-size: 2rem; color: #ff8c5a;">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
    <!-- Dynamische Auswahl je nach Zeitraum -->
    <div style="margin: 24px 0 24px 0;">
      <!-- Tag-Auswahl -->
      <mat-form-field appearance="outline" *ngIf="selectedDuration.short === '1d' || selectedDuration.short === '4h' || selectedDuration.short === '5m' || selectedDuration.short === '1h'">
        <mat-label>Choose a date</mat-label>
        <input matInput [matDatepicker]="picker" [(ngModel)]="selectedDateString" (dateChange)="onMaterialDateChange($event)" placeholder="TT.MM.JJJJ"
          [min]="minDate" [max]="maxDate">
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
      <!-- 2-Tage-Dropdown unter dem Datepicker anzeigen, wenn 2d ausgewählt ist -->
      <div *ngIf="selectedDuration.short === '2d'" class="two-day-selector" style="margin-top: 10px;">
        <label for="twoDaySelect" class="two-day-label">Starttag auswählen:</label>
        <select id="twoDaySelect" [(ngModel)]="selectedDayObj" class="two-day-dropdown" (change)="changeDuration()" [compareWith]="compareDays">
          <option *ngFor="let d of daysInYear" [ngValue]="d">{{ d.day }}. {{ months[d.month] }}</option>
        </select>
        <div class="current-two-day-info">
          Gewählter Zeitraum: <strong>{{ selectedDayObj.day }}. {{ getMonthName(selectedDayObj) }} – {{ selectedDayObj.day + 1 }}. {{ getMonthName({ day: selectedDayObj.day + 1, month: selectedDayObj.month }) }}</strong>
        </div>
      </div>
      <!-- 4-Stunden-Dropdown unter dem Datepicker anzeigen, wenn 4h ausgewählt ist -->
<!-- Nur ein Dropdown für 4h anzeigen, doppeltes entfernen -->
<div *ngIf="selectedDuration.short === '1h'" class="one-hour-selector" style="margin-top: 10px;">
  <label for="oneHourSelect" class="one-hour-label">Stunde auswählen:</label>
  <select id="oneHourSelect" [(ngModel)]="selectedHour" class="one-hour-dropdown" (change)="changeDuration()">
    <option *ngFor="let h of hourOptions" [value]="h">
      {{ h.toString().padStart(2, '0') }}:00 – {{ ((h + 1) % 24).toString().padStart(2, '0') }}:00
    </option>
  </select>
</div>
      <!-- 5-Minuten-Dropdown nur anzeigen, wenn 5m ausgewählt ist -->
      <div *ngIf="selectedDuration.short === '5m'" class="minute-selector">
        <label for="minuteSelect" class="minute-label">Wähle 5-Minuten-Intervall:</label>
        <select id="minuteSelect" [(ngModel)]="selectedMinute" class="minute-dropdown">
          <option *ngFor="let minute of minuteIntervals" [ngValue]="minute.value">
            {{ minute.label }}
          </option>
        </select>
      </div>

      <!-- Monat-Auswahl -->
      <div class="d-flex" *ngIf="selectedDuration.short === '30d'">
        <select id="yearSelect" class="form-select ms-2" [(ngModel)]="selectedYear" (change)="changeDuration()">
          <option *ngFor="let year of yearSelect" [ngValue]="year.long">{{ year.long }}</option>
        </select>
        <select id="monthSelect" class="form-select ms-2" [(ngModel)]="selectedMonth" (change)="changeDuration()">
          <option *ngFor="let month of months; let i = index" [ngValue]="i">{{ month }}</option>
        </select>
      </div>

      <!-- Wochen-Auswahl -->
      <div class="d-flex" *ngIf="selectedDuration.short === '7d'">
        <select id="yearSelect" class="form-select ms-2" [(ngModel)]="selectedYear" (change)="onWeekYearChange()">
          <option *ngFor="let year of yearSelect" [ngValue]="year.long">{{ year.long }}</option>
        </select>
        <select id="weekSelect" class="form-select ms-2" [(ngModel)]="selectedWeek" (change)="changeDuration()">
          <option *ngFor="let week of availableWeeks" [ngValue]="week">{{ week.label }}</option>
        </select>
      </div>

      <!-- Jahres-Auswahl -->
      <div class="d-flex" *ngIf="selectedDuration.short === '365d'">
        <select id="yearSelect" class="form-select ms-2" [(ngModel)]="selectedYear" (change)="changeDuration()">
          <option *ngFor="let year of yearSelect" [ngValue]="year.long">{{ year.long }}</option>
        </select>
      </div>

      <!-- Stunden-Dropdown für 1-Stunden-Ansicht -->
      <div *ngIf="selectedDuration.short === '1h'" style="margin-top: 8px;">
        <label for="hourSelect" style="margin-right: 8px;">Stunde auswählen:</label>
        <select id="hourSelect" [(ngModel)]="selectedHour" class="hour-dropdown" (change)="changeDuration()">
          <option *ngFor="let h of hourOptions" [value]="h">{{ h.toString().padStart(2, '0') }}:00 – {{ ((h + 1) % 24).toString().padStart(2, '0') }}:00</option>
        </select>
      </div>

      <!-- 4-Stunden-Dropdown für 4-Stunden-Ansicht -->
      <div *ngIf="selectedDuration.short === '4h'" style="margin-top: 8px;">
        <label for="fourHourSelect" style="margin-right: 8px;">Zeitraum auswählen:</label>
        <select id="fourHourSelect" [(ngModel)]="selectedHour" class="four-hour-dropdown" (change)="changeDuration()">
          <option *ngFor="let interval of fourHourIntervals" [value]="interval.value">
            {{ interval.label }}
          </option>
        </select>
      </div>
    </div>
    <div class="content-wrapper">
      <!-- Wetteranzeige -->
      <div *ngIf="currentIndex === -2" class="weather-section">
        <app-weather></app-weather>
      </div>
      <!-- Sensorboxen -->
      <div *ngIf="currentIndex === -3" class="sensorbox-section">
        <app-sensorbox-overview></app-sensorbox-overview>
      </div>
      <!-- Anzeige der ausgewählten Graphen -->
      <div class="container">
        <div class="row">
          <div class="col-lg-12">
            <!-- Einzelner Graph -->
            <div *ngIf="currentGraph && currentIndex != -1 && currentIndex != -2" class="graph-container mb-4">
              <div class="iframe-container">
                <div class="iframe-background"></div>
                <iframe
                  [src]="currentGraph?.iFrameLink ? getSafeUrl(currentGraph.iFrameLink) : null"
                  class="grafana-iframe"
                ></iframe>
              </div>
            </div>

            <!-- Alle Graphen im Dashboard -->
            <div *ngIf="currentIndex === -1" class="graph-container">
              <div class="row">
                <div
                  *ngFor="let graph of graphs"
                  class="col-md-6 graph-item mb-4"
                >
                  <!-- Entferne den doppelten Titel, da Sidebar die Namen zeigt -->
                  <div class="iframe-container">
                    <div class="iframe-background"></div>
                    <iframe
                      [src]="getSafeUrl(graph.iFrameLink)"
                      class="grafana-iframe"
                    ></iframe>
                  </div>
                </div>
              </div>

              <!-- Keine Graphen verfügbar -->
              <div *ngIf="graphs.length === 0" class="no-graphs">
                <p>Keine Graphen verfügbar.</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
